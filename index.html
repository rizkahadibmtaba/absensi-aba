<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Absensi ABA</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <style>
    body {
      background: #f5f7fa;
      font-family: Arial, sans-serif;
    }
    header {
      text-align: center;
      padding: 20px;
    }
    header img {
      height: 80px;
      margin-bottom: 10px;
    }
    .card {
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    #cameraSection video, #cameraSection canvas {
      width: 100%;
      border-radius: 8px;
    }
    #successMessage {
      text-align: center;
      padding: 30px;
    }
  </style>
</head>
<body>
  <header>
    <img src="https://rizkahadibmtaba.github.io/absensi-aba/assets/logo-512.png" alt="Logo ABA">
    <h3>Form Absensi ABA</h3>
  </header>

  <div class="container">
    <div class="card p-4">
      <form id="absensiForm">
        
        <!-- Dropdown Nama -->
        <div class="mb-3">
          <label for="nama" class="form-label">Nama Karyawan:</label>
          <select id="nama" name="nama" class="form-select" required>
            <option value="">-- Pilih Nama --</option>
            <option value="Dwi Arie Y">Dwi Arie Y</option>
            <option value="Suparto">Suparto</option>
            <option value="Susmiyati">Susmiyati</option>
            <option value="Citra P">Citra P</option>
            <option value="Edy S">Edy S</option>
            <option value="Fina Alviatur R">Fina Alviatur R</option>
            <option value="Noval S">Noval S</option>
            <option value="Zulfiana N A">Zulfiana N Adila</option>
          </select>
        </div>

        <!-- Hidden ID -->
        <input type="hidden" id="id" name="id">

        <!-- Jenis Keterangan -->
        <div class="mb-3">
          <label for="keterangan" class="form-label">Keterangan:</label>
          <select id="keterangan" name="keterangan" class="form-select" required>
            <option value="">-- Pilih Keterangan --</option>
            <option value="Hadir">Hadir</option>
            <option value="Terlambat">Terlambat</option>
            <option value="Izin">Izin (Cuti)</option>
            <option value="Sakit">Izin (Sakit)</option>
          </select>
        </div>

        <!-- Alasan (hidden default) -->
        <div class="mb-3" id="alasanWrapper" style="display:none;">
          <label for="alasan" class="form-label">Alasan:</label>
          <textarea id="alasan" name="alasan" class="form-control"></textarea>
        </div>

        <!-- Ambil Foto -->
        <div class="mb-3 d-none" id="cameraSection">
          <label class="form-label">Ambil Foto:</label>
          <video id="video" autoplay playsinline></video>
          <canvas id="canvas" class="d-none"></canvas>
          <div class="mt-2">
            <button type="button" class="btn btn-sm btn-primary" id="captureBtn">Ambil Foto</button>
            <button type="button" class="btn btn-sm btn-secondary d-none" id="retakeBtn">Ulangi Foto</button>
          </div>
        </div>

        <button type="submit" class="btn btn-success w-100" id="submitBtn">Kirim Absensi</button>
      </form>

      <div id="successMessage" class="d-none">
        <h5>Terimakasih telah melakukan absensi kehadiran.</h5>
      </div>
    </div>
  </div>

  <script>
    // URL Backend Apps Script
    const backendUrl = "https://script.google.com/macros/s/AKfycbzgvMgep0Qv-V32LjCFYe8Yh-vBKMcXXzFkskw8lbyLr6aF6HZ47c4E5PdSd-ffLee4/exec";

    // Konstanta ID Karyawan
    const karyawan = {
      "Dwi Arie Y": "ABA001",
      "Suparto": "ABA002",
      "Susmiyati": "ABA003",
      "Citra P": "ABA004",
      "Edy S": "ABA005",
      "Fina Alviatur R": "ABA006",
      "Noval S": "ABA007",
      "Zulfiana N A": "ABA008"
    };

    const form = document.getElementById("absensiForm");
    const namaSelect = document.getElementById("nama");
    const idInput = document.getElementById("id");
    const keteranganSelect = document.getElementById("keterangan");
    const alasanWrapper = document.getElementById("alasanWrapper");
    const alasanField = document.getElementById("alasan");
    const cameraSection = document.getElementById("cameraSection");
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const captureBtn = document.getElementById("captureBtn");
    const retakeBtn = document.getElementById("retakeBtn");
    const submitBtn = document.getElementById("submitBtn");
    const successMessage = document.getElementById("successMessage");

    let photoData = "";
    let stream;

    // Isi otomatis ID
    namaSelect.addEventListener("change", () => {
      idInput.value = karyawan[namaSelect.value] || "";
    });

    // Toggle Kamera + Alasan
    function toggleFields() {
      if (keteranganSelect.value === "Hadir") {
        cameraSection.classList.remove("d-none");
        alasanWrapper.style.display = "none";
        startCamera();
      } else if (
        keteranganSelect.value === "Terlambat" ||
        keteranganSelect.value === "Izin" ||
        keteranganSelect.value === "Sakit"
      ) {
        cameraSection.classList.add("d-none");
        stopCamera();
        photoData = "";
        alasanWrapper.style.display = "block";
      } else {
        cameraSection.classList.add("d-none");
        alasanWrapper.style.display = "none";
        stopCamera();
      }
    }
    keteranganSelect.addEventListener("change", toggleFields);

    // Start Camera
    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
      } catch (err) {
        alert("Kamera tidak bisa diakses.");
      }
    }

    // Stop Camera
    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }
    }

    // Capture Photo
    captureBtn.addEventListener("click", () => {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext("2d").drawImage(video, 0, 0);
      photoData = canvas.toDataURL("image/png");
      video.classList.add("d-none");
      canvas.classList.remove("d-none");
      captureBtn.classList.add("d-none");
      retakeBtn.classList.remove("d-none");
    });

    // Retake Photo
    retakeBtn.addEventListener("click", () => {
      photoData = "";
      video.classList.remove("d-none");
      canvas.classList.add("d-none");
      captureBtn.classList.remove("d-none");
      retakeBtn.classList.add("d-none");
    });

    // Submit Form
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      submitBtn.textContent = "Mengirim...";
      submitBtn.disabled = true;

      const formData = new FormData();
      formData.append("nama", namaSelect.value);
      formData.append("id", idInput.value);
      formData.append("keterangan", keteranganSelect.value);
      formData.append("alasan", alasanField.value);
      formData.append("foto", photoData);

      try {
        await fetch(backendUrl, {
          method: "POST",
          body: formData
        });

        form.classList.add("d-none");
        successMessage.classList.remove("d-none");
      } catch (err) {
        alert("Gagal mengirim absensi, coba lagi.");
      } finally {
        submitBtn.textContent = "Kirim Absensi";
        submitBtn.disabled = false;
        stopCamera();
      }
    });
  </script>
</body>
</html>
