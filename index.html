<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Absensi BMT ABA</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="logo.png" type="image/png" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f7f9fb;
      margin: 0;
      padding: 0;
      text-align: center;
    }
    header {
      background: #2e7d32;
      color: white;
      padding: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    header img {
      height: 40px;
      margin-right: 10px;
    }
    main {
      padding: 20px;
    }
    label {
      display: block;
      margin-top: 15px;
      font-weight: bold;
      text-align: left;
    }
    select, input, button, textarea {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    button {
      margin-top: 15px;
      cursor: pointer;
      font-weight: bold;
      background: #2e7d32;
      color: white;
      border: none;
    }
    button.secondary {
      background: #d32f2f;
    }
    video, canvas, img.preview {
      margin-top: 10px;
      width: 100%;
      max-width: 320px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    .hidden { display: none; }
  </style>
</head>
<body>
  <header>
    <img src="logo.png" alt="Logo" />
    <h2>Absensi BMT ABA</h2>
  </header>

  <main id="form-section">
    <form id="absensiForm">
      <!-- Nama -->
      <label for="nama">Nama Karyawan:</label>
      <select id="nama" name="nama" required>
        <option value="">-- Pilih Nama --</option>
        <option value="Dwi Arie Y">Dwi Arie Y</option>
        <option value="Suparto">Suparto</option>
        <option value="Susmiyati">Susmiyati</option>
        <option value="Citra P">Citra P</option>
        <option value="Edy S">Edy S</option>
        <option value="Fina Alviatur R">Fina Alviatur R</option>
        <option value="Noval S">Noval S</option>
        <option value="Zulfiana N A">Zulfiana N Adila</option>
      </select>

      <!-- Status -->
      <label for="status">Status Kehadiran:</label>
      <select id="status" name="status" required>
        <option value="Hadir">Hadir</option>
        <option value="Hadir Terlambat">Hadir Terlambat</option>
        <option value="Ijin Cuti">Ijin Cuti</option>
        <option value="Ijin Sakit">Ijin Sakit</option>
      </select>

      <!-- Alasan -->
      <div id="alasanField" class="hidden">
        <label for="alasan">Alasan:</label>
        <textarea id="alasan" name="alasan"></textarea>
      </div>

      <!-- Kamera -->
      <div id="cameraSection" class="hidden">
        <video id="video" autoplay></video>
        <button type="button" id="takePhoto">üì∏ Ambil Foto</button>
        <canvas id="canvas" class="hidden"></canvas>
        <img id="photoPreview" class="preview hidden" />
        <button type="button" id="retakePhoto" class="secondary hidden">üîÑ Ulangi Foto</button>
      </div>

      <button type="submit">‚úÖ Submit Absensi</button>
    </form>
  </main>

  <main id="thanks-section" class="hidden">
    <h2>Terima kasih telah melakukan absensi üôè</h2>
  </main>

  <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbzgvMgep0Qv-V32LjCFYe8Yh-vBKMcXXzFkskw8lbyLr6aF6HZ47c4E5PdSd-ffLee4/exec";

    const karyawan = {
      "Dwi Arie Y": "ABA001",
      "Suparto": "ABA002",
      "Susmiyati": "ABA003",
      "Citra P": "ABA004",
      "Edy S": "ABA005",
      "Fina Alviatur R": "ABA006",
      "Noval S": "ABA007",
      "Zulfiana N A": "ABA008"
    };

    const statusSelect = document.getElementById("status");
    const alasanField = document.getElementById("alasanField");
    const cameraSection = document.getElementById("cameraSection");
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const photoPreview = document.getElementById("photoPreview");
    const takePhotoBtn = document.getElementById("takePhoto");
    const retakePhotoBtn = document.getElementById("retakePhoto");

    let fotoData = "";

    // Show/hide fields
    statusSelect.addEventListener("change", () => {
      const status = statusSelect.value;
      if (status === "Hadir") {
        alasanField.classList.add("hidden");
        cameraSection.classList.remove("hidden");
        startCamera();
      } else {
        alasanField.classList.remove("hidden");
        cameraSection.classList.add("hidden");
        stopCamera();
      }
    });

    function startCamera() {
      navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => { video.srcObject = stream; })
        .catch(err => console.error("Camera error:", err));
    }
    function stopCamera() {
      if (video.srcObject) {
        video.srcObject.getTracks().forEach(track => track.stop());
      }
    }

    takePhotoBtn.addEventListener("click", () => {
      const ctx = canvas.getContext("2d");
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0);
      fotoData = canvas.toDataURL("image/png");
      photoPreview.src = fotoData;
      photoPreview.classList.remove("hidden");
      canvas.classList.add("hidden");
      video.classList.add("hidden");
      takePhotoBtn.classList.add("hidden");
      retakePhotoBtn.classList.remove("hidden");
    });

    retakePhotoBtn.addEventListener("click", () => {
      fotoData = "";
      photoPreview.classList.add("hidden");
      video.classList.remove("hidden");
      takePhotoBtn.classList.remove("hidden");
      retakePhotoBtn.classList.add("hidden");
      startCamera();
    });

    // Submit form
    document.getElementById("absensiForm").addEventListener("submit", e => {
      e.preventDefault();
      const nama = document.getElementById("nama").value;
      const id = karyawan[nama] || "";
      const status = statusSelect.value;
      const alasan = document.getElementById("alasan").value;

      fetch(scriptURL, {
        method: "POST",
        body: new URLSearchParams({ id, nama, status, alasan, foto: fotoData })
      })
        .then(() => {
          document.getElementById("form-section").classList.add("hidden");
          document.getElementById("thanks-section").classList.remove("hidden");
          stopCamera();
        })
        .catch(err => alert("Error: " + err));
    });
  </script>
</body>
</html>
