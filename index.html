<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Absensi Karyawan BMT ABA</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <style>
    body {
      background: #f5f7fa;
    }
    .card {
      border-radius: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    video, canvas {
      width: 100%;
      border-radius: 12px;
    }
    .btn {
      border-radius: 12px;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="container d-flex justify-content-center align-items-center min-vh-100">
    <div class="card p-4" style="max-width: 450px; width: 100%;">
      <h3 class="text-center mb-1"><b>Absensi Karyawan BMT ABA</b></h3>
      <h5 class="text-center text-primary mb-3" id="clock"></h5>

      <!-- Form Absensi -->
      <form id="absenForm">
        <div class="mb-3">
          <label class="form-label">Nama Karyawan:</label>
          <select id="namaKaryawan" class="form-select" required></select>
        </div>
        <div class="mb-3">
          <label class="form-label">ID Karyawan:</label>
          <input type="text" id="idKaryawan" class="form-control" readonly>
        </div>
        <div class="mb-3">
          <label class="form-label">Keterangan:</label>
          <select id="keterangan" class="form-select" required>
            <option value="Hadir">Hadir</option>
            <option value="Terlambat">Terlambat</option>
            <option value="Izin">Izin (Cuti)</option>
            <option value="Sakit">Izin (Sakit)</option>
          </select>
        </div>

        <!-- Alasan jika sakit / izin -->
        <textarea id="alasan" name="alasan" placeholder="Tuliskan alasan (contoh: sakit kepala, urusan keluarga, dsb)" style="display:none;"></textarea>

        <!-- Kamera -->
        <div id="cameraSection" class="mb-3 text-center">
          <video id="video" autoplay playsinline></video>
          <canvas id="canvas" class="d-none"></canvas>
          <button type="button" id="ambilFoto" class="btn btn-primary w-100 mt-2">Ambil Foto</button>
          <button type="button" id="ulangiFoto" class="btn btn-danger w-100 mt-2 d-none">Ulangi Foto</button>
        </div>

        <button type="submit" id="submitBtn" class="btn btn-success w-100">Kirim Absensi</button>
      </form>

      <!-- Pesan sukses -->
      <div id="successMessage" class="text-center mt-4 d-none">
        <h5 class="text-success"><b>Terima kasih sudah absen üôè</b></h5>
      </div>
    </div>
  </div>

  <script>
    // URL backend Apps Script otomatis
    const backendUrl = "https://script.google.com/macros/s/AKfycbzgvMgep0Qv-V32LjCFYe8Yh-vBKMcXXzFkskw8lbyLr6aF6HZ47c4E5PdSd-ffLee4/exec"; 

    // Daftar karyawan
    const karyawan = {
      "": "Pilih Nama",
      "Dwi Arie Y": "ABA001",
      "Suparto": "ABA002",
      "Susmiyati": "ABA003",
      "Citra P": "ABA004",
      "Edy S": "ABA005",
      "Fina Alviatur R": "ABA006",
      "Noval S": "ABA007",
      "Zulfiana N A": "ABA008"
    };

    const namaSelect = document.getElementById("namaKaryawan");
    const idInput = document.getElementById("idKaryawan");
    const keteranganSelect = document.getElementById("keterangan");
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const ambilFotoBtn = document.getElementById("ambilFoto");
    const ulangiFotoBtn = document.getElementById("ulangiFoto");
    const cameraSection = document.getElementById("cameraSection");
    const form = document.getElementById("absenForm");
    const submitBtn = document.getElementById("submitBtn");
    const successMessage = document.getElementById("successMessage");

    let stream;
    let photoData = "";

    // Isi dropdown nama karyawan
    Object.keys(karyawan).forEach(nama => {
      const option = document.createElement("option");
      option.value = nama;
      option.textContent = nama;
      namaSelect.appendChild(option);
    });

    // Auto set ID Karyawan
    namaSelect.addEventListener("change", () => {
      idInput.value = karyawan[namaSelect.value] || "";
    });

    // Set default
    namaSelect.value = Object.keys(karyawan)[0];
    idInput.value = karyawan[namaSelect.value];

    // Kamera
    async function startCamera() {
      if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
      }
    }

    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }
    }

    // Toggle kamera sesuai keterangan
    function toggleCamera() {
      if (keteranganSelect.value === "Hadir") {
        cameraSection.classList.remove("d-none");
        startCamera();
      } else {
        cameraSection.classList.add("d-none");
        stopCamera();
        photoData = "";
      }
    }

    keteranganSelect.addEventListener("change", toggleCamera);
    toggleCamera(); // initial

    // Ambil foto
    ambilFotoBtn.addEventListener("click", () => {
      const context = canvas.getContext("2d");
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      context.drawImage(video, 0, 0, canvas.width, canvas.height);
      photoData = canvas.toDataURL("image/png");

      video.classList.add("d-none");
      canvas.classList.remove("d-none");
      ambilFotoBtn.classList.add("d-none");
      ulangiFotoBtn.classList.remove("d-none");
    });

    // Ulangi foto
    ulangiFotoBtn.addEventListener("click", () => {
      video.classList.remove("d-none");
      canvas.classList.add("d-none");
      ambilFotoBtn.classList.remove("d-none");
      ulangiFotoBtn.classList.add("d-none");
      photoData = "";
    });

    // Kirim absensi
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      submitBtn.textContent = "Mengirim...";
      submitBtn.disabled = true;

      const data = {
        nama: namaSelect.value,
        id: idInput.value,
        keterangan: keteranganSelect.value,
        foto: photoData
      };

      try {
        await fetch(backendUrl, {
          method: "POST",
          body: JSON.stringify(data),
          headers: { "Content-Type": "application/json" }
        });

        form.classList.add("d-none");
        successMessage.classList.remove("d-none");
      } catch (err) {
        alert("Gagal mengirim absensi, coba lagi.");
      } finally {
        submitBtn.textContent = "Kirim Absensi";
        submitBtn.disabled = false;
      }
    });

    // Jam realtime
    function updateClock() {
      const now = new Date();
      const time = now.toLocaleTimeString("id-ID", { hour12: false });
      document.getElementById("clock").textContent = time;
    }
    setInterval(updateClock, 1000);
    updateClock();
  </script>
</body>
</html>
